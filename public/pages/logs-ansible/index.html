<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>(mcorbin.fr): Use your Ansible logs !</title>
    <link rel="canonical" href="http://mcorbin.fr/pages/logs-ansible/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82339305-1', 'auto');
  ga('send', 'pageview');

    </script>
  </head>
  <body><a name="top"></a>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">(mcorbin.fr)</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li ><a href="/">Home</a></li>
            <li
               ><a href="/archives/">Archives</a></li>
            
            <li
               >
              <a href="/pages/about/">A propos/About</a>
            </li>
            
            <li><a href="/feed.xml">RSS</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div><!--/.container-fluid -->
    </nav>


    <div class="container">
      <div class="row">
        <div class="col-lg-9">
          <div id="content">
            
<div id="custom-page">
    <div id="page-header">
        <h2>Use your Ansible logs !</h2>
    </div>
    
    <p><div id="post-meta">10 august 2016</div></p><p>I use Ansible on a daily basis. Everyday, my coworkers and i use it to configure our servers and deploy our applications. We use Jenkins to call Ansible commands.</p><p>All of this generates a <strong>huge</strong> amount of logs. We do not do much with these logs, except consulting them after a deployment with the Jenkins interface.</p><p>I explain in this post a way to exploit these logs, using Ansible callback plugins. With these plugins, it is possible to get detailed Ansible logs, and easily manipulate them to produce statistics and new information.</p><h2><a name="ansible&#95;callback&#95;plugins"></a>Ansible callback plugins</h2><h3><a name="&nbsp;&nbsp;&nbsp;&nbsp;&#95;<strong>general&#95;presentation</strong>"></a>&nbsp;&nbsp;&nbsp;&nbsp; <strong>General presentation</strong></h3><p>Ansible can be "extended" with plugins. I will present here the callback plugin type <a href='http://docs.ansible.com/ansible/developing_plugins.html#callbacks'>(documentation)</a>. The examples in this post used Ansible 1.X, but the Ansible 2.X callback plugins are almost the same as Ansible 1.X.</p><p>This plugin allows to define an object whose functions will be called at different times during the Ansible execution. Example:</p><pre><code class="python">class CallbackModule&#40;object&#41;:

    def on&#95;any&#40;self, &#42;args, &#42;&#42;kwargs&#41;:
        pass

    def runner&#95;on&#95;failed&#40;self, host, res, ignore&#95;errors=False&#41;:
        pass

    def runner&#95;on&#95;ok&#40;self, host, res&#41;:
        pass

    def runner&#95;on&#95;skipped&#40;self, host, item=None&#41;:
        pass

    def playbook&#95;on&#95;start&#40;self&#41;:
        pass

    def playbook&#95;on&#95;task&#95;start&#40;self, name, is&#95;conditional&#41;:
        pass

    # etc...

</code></pre><p>A callback plugin is just a class implementing some functions. I put a few of them in this example, but there are many more for any Ansible event type (you can find these functions in the Ansible doc or in the callback plugins provided with Ansible).</p><h3><a name="&nbsp;&nbsp;&nbsp;&nbsp;&#95;<strong>detailed&#95;presentation</strong>"></a>&nbsp;&nbsp;&nbsp;&nbsp; <strong>Detailed presentation</strong></h3><p>For example, the <strong>runner&#95;on&#95;failed</strong> function will be called when an Ansible task fails, <strong>runner&#95;on&#95;ok</strong> when an Ansible task is successfull, <strong>runner&#95;on&#95;skipped</strong> when a task is skipped...</p><p>Functions which begin with <strong>playbook&#95;on_</strong> will be executed by events related to playbooks (example: <strong>playbook&#95;on&#95;start</strong> when a playbook start...).</p><p>All these functions receive parameters. This is where it gets interesting. For example, <strong>runner&#95;on&#95;ok</strong> receives the <strong>self</strong>, <strong>host</strong>, and <strong>res</strong> parameters.</p><ul><li>The <strong>host</strong> variable contains the host on which the task applies.</li><li>The <strong>res</strong> variable contains some informations about the host (<em>fact</em> variables), as well as some informations about the task being called (task <em>changed</em> or not, Ansible module called in the task...).</li><li>The callback object <strong>self</strong> contains a lot of informations on the current Ansible execution. Let's add <strong>import pdb; pdb.set_trace();</strong> in the <strong>runner&#95;on&#95;ok</strong> function (to use the Python debugger) and let's start an Ansible deployment. A <strong>pp dir(self)</strong> allows to list the fields of the object:</li></ul><pre><code>&#40;Pdb&#41; pp dir&#40;self&#41;
&#91;'&#95;&#95;class&#95;&#95;',
 '&#95;&#95;delattr&#95;&#95;',
 '&#95;&#95;dict&#95;&#95;',
 '&#95;&#95;doc&#95;&#95;',
 '&#95;&#95;format&#95;&#95;',
 '&#95;&#95;getattribute&#95;&#95;',
 '&#95;&#95;hash&#95;&#95;',
 '&#95;&#95;init&#95;&#95;',
 '&#95;&#95;module&#95;&#95;',
 '&#95;&#95;new&#95;&#95;',
 '&#95;&#95;reduce&#95;&#95;',
 '&#95;&#95;reduce&#95;ex&#95;&#95;',
 '&#95;&#95;repr&#95;&#95;',
 '&#95;&#95;setattr&#95;&#95;',
 '&#95;&#95;sizeof&#95;&#95;',
 '&#95;&#95;str&#95;&#95;',
 '&#95;&#95;subclasshook&#95;&#95;',
 '&#95;&#95;weakref&#95;&#95;',
 'on&#95;any',
 'play',
 'playbook',
 'playbook&#95;on&#95;import&#95;for&#95;host',
 'playbook&#95;on&#95;no&#95;hosts&#95;matched',
 'playbook&#95;on&#95;no&#95;hosts&#95;remaining',
 'playbook&#95;on&#95;not&#95;import&#95;for&#95;host',
 'playbook&#95;on&#95;notify',
 'playbook&#95;on&#95;play&#95;start',
 'playbook&#95;on&#95;setup',
 'playbook&#95;on&#95;start',
 'playbook&#95;on&#95;stats',
 'playbook&#95;on&#95;task&#95;start',
 'playbook&#95;on&#95;vars&#95;prompt',
 'runner&#95;on&#95;async&#95;failed',
 'runner&#95;on&#95;async&#95;ok',
 'runner&#95;on&#95;async&#95;poll',
 'runner&#95;on&#95;failed',
 'runner&#95;on&#95;no&#95;hosts',
 'runner&#95;on&#95;ok',
 'runner&#95;on&#95;skipped',
 'runner&#95;on&#95;unreachable',
 'state',
 'task'&#93;
</code></pre><p>The <strong>self</strong> object is a gold mine ! Using pdb (<code>pp dir&#40;self.task&#41;</code>, <code>pp dir&#40;self.play&#41;</code> etc...), we see that we have access to a huge amount of informations about our deployment. Detail of the current task (name, role...), Ansible variables, information about the playbook... Now we can use them ! Of course, each function in the callback plugin will have differents parameters (but some are similar, like <strong>runner&#95;on&#95;failed</strong> et <strong>runner&#95;on&#95;ok</strong>).</p><h3><a name="&nbsp;&nbsp;&nbsp;&nbsp;&#95;<strong>playbook&#95;on&#95;start</strong>"></a>&nbsp;&nbsp;&nbsp;&nbsp; <strong>playbook on start</strong></h3><p>The <strong>playbook&#95;on&#95;start</strong> function is called when a playbook is launched. I wanted to initialize some variables on the callback object from extra&#95;vars passed to the <em>ansible&#95;playbook</em> command. Here is a basic example (<strong>get&#95;timestamp</strong> is a function returning the current timestamp is second):</p><pre><code class="python">def playbook&#95;on&#95;start&#40;self&#41;:
        extra&#95;vars = self.playbook.extra&#95;vars
        self.project = extra&#95;vars&#91;&quot;project&quot;&#93;
        self.version = extra&#95;vars&#91;&quot;version&quot;&#93;
        self.environment = extra&#95;vars&#91;&quot;environment&quot;&#93;
        self.start&#95;timestamp = get&#95;timestamp&#40;&#41;
</code></pre>Here, i get 3 extra_vars variables (<strong>projet</strong>, the project i deploy, <strong>version</strong>, the deployed version, <strong>environment</strong>, the target environment : dev, prod...) and set them to the self object. I also initialize a <strong>start&#95;timestamp</strong> variable, which contains the time when the playbook begins.<br/><br/>In short, it is easy to define more variables in the self object. These variables can be used later in others functions.<h3><a name="&nbsp;&nbsp;&nbsp;&nbsp;&#95;<strong>playbook&#95;on&#95;stats</strong>"></a>&nbsp;&nbsp;&nbsp;&nbsp; <strong>playbook on stats</strong></h3><p>The <strong>playbook&#95;on&#95;stats</strong> function is called at the end of a deployment, and makes it possible to get the deployment summary (unreachable, skipped, changed tasks...), by host. Example :</p><pre><code class="python">def playbook&#95;on&#95;stats&#40;self, stats&#41;:
    hosts = stats.processed.keys&#40;&#41;
    for h in hosts:
        summary = stats.summarize&#40;h&#41;
</code></pre><p>You can for example get a summary by host, or generates a global summary.</p><h2><a name="<strong>log&#95;generation<em>"></a></strong>Log generation</em></h2><p>Now, you just need to write the callback object functions for generating logs to the desired format. Here is a simple example which sends (using the <strong>requests</strong> package) a log to a webserver when a task fails: </p><pre><code class="python">def runner&#95;on&#95;failed&#40;self, host, res, ignore&#95;errors=False&#41;:
    task = self.task
    result = {
        &quot;timestamp&quot;: get&#95;timestamp&#40;&#41;,
        &quot;host&quot;: host,
        &quot;type&quot;: &quot;task&#95;failed&quot;,
        &quot;task&quot;: task.name,
        &quot;role&quot;: task.role&#95;name,
        &quot;result&quot;: json.dumps&#40;res&#41;,
        &quot;version&quot;: self.version,  # variables from extra&#95;vars &#40;see before&#41;
        &quot;environment&quot;: self.environment,
        &quot;project&quot;: self.project,
        &quot;start&#95;timestamp&quot;: self.start&#95;timestamp
    }
    requests.post&#40;url&#95;web&#95;server, data=json.dumps&#40;result&#41;&#41;
</code></pre><p>This log will contain the timestamp of the task, the host, the task type <em>task&#95;failed</em>), the task name, the role, and the self variables defined earlier in <strong>playbook&#95;on&#95;start</strong>.</p><p>You can write a similar code in all other functions, and your web server will receive very interesting logs.</p><h2><a name="<strong>collect&#95;and&#95;store&#95;your&#95;logs</strong>"></a><strong>Collect and store your logs</strong></h2><p>Possibilities in callback plugins are endless. I chose to send my logs to a Python web server using Flask. Then, the web server sends the log to Kafka. Logstash collects the logs from Kafka, and push them into Elasticsearch.</p><p><center><img src="/img/ansible_log.png" alt="Ansible log architecture" /></center></p><p>With Elasticsearch, you can make complex queries and graphs on your logs using Kibana and Grafana.</p><h2><a name="<strong>exploit&#95;logs</strong>"></a><strong>Exploit logs</strong></h2><p>With informations provided by a simple callback plugin, i can:</p><ul><li>Make complex queries in Kibana (example: get all the failed tasks for my HAproxy role for a particular projet on the pre-production environment). Furthermore, all logs are centralized in the same place, and not scattered into multiples Jenkins instances/jobs.</li><li>In Grafana, by project:<ul><li>Summaries of the last deployments (start time, environment, success or not, number of tasks skipped/changed/unreachable...).</li><li>List of all started deployments (including the current ones).</li><li>List of all completed deployments.</li><li>Numvber of task for each role with their types (changed, skipped, success...).</li><li>Number of time a role has failed.</li><li>Least reliable roles list.</li><li>Execution time of each role (max, min, average...).</li></ul></li></ul><p><center><img src="/img/ansible_grafana1.png" alt="Exemple de graphes avec Grafana" /></center></p><p><center><img src="/img/ansible_grafana2.png" alt="Exemple de graphes avec Grafana" /></center></p><p><center><em>These two images (anonumized) show these graphs. largest image format <a href='/img/ansible_grafana1.png'>here</a> and <a href='/img/ansible_grafana2.png'>here</a></em></center></p><p>Considers transforming some logs, for example the <strong>res</strong> parameter. These parameters can be very long (thousands of characters), particularly on certain tasks like <em>unarchive</em>. You can for example truncate too long messages.</p><h2><a name="<strong>ansible&#95;2</strong>"></a><strong>Ansible 2</strong></h2><p>The <a href='https://docs.ansible.com/ansible/porting_guide_2.0.html'>porting guide</a> shows how to use the callback plugins in Ansible 2. Unfortunaly, parts of the code must change :</p><ul><li>extra_vars are not accessibles in <strong>playbook&#95;on&#95;start</strong> but only from <strong>v2&#95;playbook&#95;on&#95;play&#95;start</strong>, in a different way:</li></ul><pre><code class="python">extra&#95;vars = play.get&#95;variable&#95;manager&#40;&#41;.extra&#95;vars
</code></pre><p>The role name is accessible in <strong>v2&#95;playbook&#95;on&#95;task&#95;start</strong>. You can do for example:</p><pre><code class="python">if task.&#95;role is not None:  # on verifie si c'est un role ou non
    task.role&#95;name = task.&#95;role.&#95;role&#95;name
</code></pre><h2><a name="<strong>conclusion</strong>"></a><strong>Conclusion</strong></h2><p>You can do a lot of things with Ansible callback plugins. I think it is possible to build with them a real Ansible control center (with statistics, alerting...).</p>

    <div id="prev-next">
        
        
        
        <a href="/pages/lesspipe/">One day one manpage: lesspipe &raquo;</a>
        
    </div>
</div>

            <a href="#top">Top of page</a>
          </div>
        </div>

        <div class="col-md-3">
          <div id="sidebar">
            <h3>Links</h3>
            <ul id="links">
              <li>- <a href="http://clojure.org/">clojure.org</a></li>
            
            <div id="recent">
              <h3>Recent posts</h3>
              <ul>
                
                <li>- <a href="/posts/10-08-2016-logs-ansible/">Exploitez vos logs Ansible ! / Use your Ansible logs !</a></li>
                
                <li>- <a href="/posts/22-04-2016-lesspipe/">Un jour une manpage / one day one manpage: lesspipe</a></li>
                
              </ul>
            </div>
            
            
            <div id="tags">
              <h3>Tags</h3>
              <ul>
                
                <li>- <a href="/tags/ansible/">ansible</a></li>
                
                <li>- <a href="/tags/linux/">linux</a></li>
                
                <li>- <a href="/tags/manpage/">manpage</a></li>
                
              </ul>
            </div>
            
          </div>
        </div>
      </div>
      <footer>Copyright &copy;  mcorbin
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="/js/highlight.pack.js" type="text/javascript"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
